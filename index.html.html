<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Sistema de Segurança do Trabalho</title>
    <style>
        /* Reset e Configurações Gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        /* Container Principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            background: #3498db;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo-text h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: flex-end;
        }
        
        /* Layout Principal */
        .main-content {
            display: flex;
            min-height: calc(100vh - 120px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
        }
        
        .menu-section {
            margin-bottom: 25px;
        }
        
        .menu-title {
            padding: 0 20px 10px;
            font-size: 12px;
            text-transform: uppercase;
            color: #7f8c8d;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #2c3e50;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: #3498db;
        }
        
        .menu-item.active {
            background: #e8f4fc;
            border-left-color: #3498db;
            color: #2980b9;
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        /* Conteúdo */
        .content {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
        }
        
        /* Cards e Dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .card-icon.clientes { background: #3498db; }
        .card-icon.colaboradores { background: #2ecc71; }
        .card-icon.epis { background: #e74c3c; }
        .card-icon.extintores { background: #f39c12; }
        
        .card-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .card-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* Formulários */
        .form-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .form-title {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Tabelas */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* Página de Login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        .login-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo .logo-icon {
            margin: 0 auto 15px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Mensagens */
        .alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* Filtros e Controles */
        .filters-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .actions-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        /* Empresa Selector */
        .empresa-selector {
            background: white;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .empresa-selector label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .empresa-selector select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 200px;
        }
        
        /* Relatórios */
        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .report-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .report-icon {
            font-size: 40px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 600px;
            }
            
            .filters-container {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
        }
        
        /* Utilitários */
        .d-flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .align-center {
            align-items: center;
        }
        
        .gap-1 {
            gap: 5px;
        }
        
        .gap-2 {
            gap: 10px;
        }
        
        .gap-3 {
            gap: 15px;
        }
        
        .w-100 {
            width: 100%;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Status dos EPIs */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-aprovado { background: #2ecc71; }
        .status-inspecionar { background: #f39c12; }
        .status-reprovado { background: #e74c3c; }
        .status-manutencao { background: #3498db; }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <div class="logo-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1>SAS Sistema</h1>
                <p>Segurança do Trabalho</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Usuário</label>
                <input type="text" class="form-control" id="loginUsername" placeholder="Digite seu usuário">
            </div>
            
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" class="form-control" id="loginPassword" placeholder="Digite sua senha">
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary w-100" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
            </div>
            
            <div class="text-center mt-3" style="color: #7f8c8d;">
                <small>
                    <strong>Credenciais de teste:</strong><br>
                    admin / admin123 (todas as empresas)<br>
                    empresa1 / 123456 (apenas Empresa 1)<br>
                    empresa2 / 123456 (apenas Empresa 2)
                </small>
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" style="display: none;">
        <div class="header">
            <div class="container">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="logo-text">
                        <h1>SAS Sistema</h1>
                        <p>Gestão de Segurança do Trabalho</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div>
                        <strong id="currentUserName">Usuário</strong><br>
                        <small id="currentUserRole">Tipo de Usuário</small><br>
                        <small id="currentEmpresaNome" style="opacity: 0.8;"></small>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Seletor de Empresa -->
        <div id="empresaSelector" class="empresa-selector" style="display: none;">
            <div class="container d-flex justify-between align-center">
                <div class="d-flex align-center gap-3">
                    <label for="empresaSelect"><i class="fas fa-building"></i> Empresa:</label>
                    <select id="empresaSelect" class="form-control" style="width: auto;" onchange="changeEmpresa()">
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                </div>
                <div>
                    <span id="empresaInfo" style="color: #7f8c8d;"></span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="menu-section">
                    <div class="menu-title">Dashboard</div>
                    <div class="menu-item active" onclick="loadPage('dashboard')">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">Cadastros</div>
                    <div class="menu-item" onclick="loadPage('clientes')">
                        <i class="fas fa-building"></i>
                        <span>Clientes</span>
                    </div>
                    <div class="menu-item" onclick="loadPage('colaboradores')">
                        <i class="fas fa-users"></i>
                        <span>Colaboradores</span>
                    </div>
                    <div class="menu-item" onclick="loadPage('fornecedores')">
                        <i class="fas fa-truck"></i>
                        <span>Fornecedores</span>
                    </div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">EPIs e Segurança</div>
                    <div class="menu-item" onclick="loadPage('epis')">
                        <i class="fas fa-hard-hat"></i>
                        <span>Cadastro de EPIs</span>
                    </div>
                    <div class="menu-item" onclick="loadPage('inspecao-epi')">
                        <i class="fas fa-search"></i>
                        <span>Inspeção de EPIs</span>
                    </div>
                    <div class="menu-item" onclick="loadPage('extintores')">
                        <i class="fas fa-fire-extinguisher"></i>
                        <span>Extintores</span>
                    </div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">Relatórios</div>
                    <div class="menu-item" onclick="loadPage('relatorios')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatórios</span>
                    </div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">Normas</div>
                    <div class="menu-item" onclick="loadPage('nrs')">
                        <i class="fas fa-book"></i>
                        <span>Normas Regulamentadoras</span>
                    </div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">Administração</div>
                    <div class="menu-item" onclick="loadPage('empresas')">
                        <i class="fas fa-industry"></i>
                        <span>Empresas</span>
                    </div>
                    <div class="menu-item" onclick="loadPage('usuarios')">
                        <i class="fas fa-user-cog"></i>
                        <span>Usuários do Sistema</span>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo Dinâmico -->
            <div class="content" id="pageContent">
                <!-- O conteúdo das páginas será carregado aqui -->
            </div>
        </div>
    </div>

    <!-- Modal Genérico -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Título do Modal</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                Conteúdo do modal
            </div>
        </div>
    </div>

    <!-- Scripts para relatórios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Sistema de Gerenciamento de Dados
        let currentUser = null;
        let currentEmpresaId = null;
        let editingId = null;
        let sistemaData = JSON.parse(localStorage.getItem('sistemaData')) || {};
        
        // Inicializar estrutura de dados
        function initializeDataStructure() {
            if (!sistemaData.empresas) {
                sistemaData.empresas = [
                    {
                        id: 1,
                        nome: 'Empresa 1',
                        cnpj: '11.111.111/0001-11',
                        responsavel: 'João Silva',
                        telefone: '(11) 9999-8888',
                        email: 'contato@empresa1.com',
                        status: 'Ativa'
                    },
                    {
                        id: 2,
                        nome: 'Empresa 2',
                        cnpj: '22.222.222/0001-22',
                        responsavel: 'Maria Santos',
                        telefone: '(21) 7777-6666',
                        email: 'contato@empresa2.com',
                        status: 'Ativa'
                    }
                ];
            }
            
            if (!sistemaData.usuarios) {
                sistemaData.usuarios = [
                    { 
                        id: 1, 
                        username: 'admin', 
                        password: 'admin123', 
                        nome: 'Administrador', 
                        role: 'admin',
                        empresas: [1, 2] // Acessa todas as empresas
                    },
                    { 
                        id: 2, 
                        username: 'empresa1', 
                        password: '123456', 
                        nome: 'Gerente Empresa 1', 
                        role: 'user',
                        empresas: [1] // Apenas empresa 1
                    },
                    { 
                        id: 3, 
                        username: 'empresa2', 
                        password: '123456', 
                        nome: 'Gerente Empresa 2', 
                        role: 'user',
                        empresas: [2] // Apenas empresa 2
                    }
                ];
            }
            
            // Inicializar dados por empresa
            sistemaData.empresas.forEach(empresa => {
                if (!sistemaData[`empresa_${empresa.id}`]) {
                    sistemaData[`empresa_${empresa.id}`] = {
                        clientes: [],
                        colaboradores: [],
                        fornecedores: [],
                        epis: [],
                        extintores: [],
                        inspecoes: []
                    };
                }
            });
            
            // Adicionar dados de exemplo se não existirem
            initializeSampleData();
            
            saveToLocalStorage();
        }
        
        // Inicializar dados de exemplo
        function initializeSampleData() {
            // Dados de exemplo para Empresa 1
            const empresa1 = sistemaData[`empresa_1`];
            if (empresa1.clientes.length === 0) {
                empresa1.clientes = [
                    { 
                        id: generateId(), 
                        nome: 'Cliente A', 
                        cnpj: '12.345.678/0001-90', 
                        email: 'clientea@email.com', 
                        telefone: '(11) 1111-1111', 
                        responsavel: 'Carlos Oliveira',
                        dataCadastro: new Date().toISOString().split('T')[0]
                    }
                ];
                
                empresa1.colaboradores = [
                    { 
                        id: generateId(), 
                        nome: 'Ana Costa', 
                        cpf: '111.222.333-44', 
                        cargo: 'Técnico de Segurança', 
                        empresa: 'Cliente A', 
                        epi: 'Sim', 
                        validade: '2024-12-31',
                        dataAdmissao: '2023-01-15'
                    }
                ];
                
                empresa1.epis = [
                    { 
                        id: generateId(), 
                        tipo: 'Capacete', 
                        marca: '3M', 
                        lote: 'LOT001', 
                        validade: '2024-08-30', 
                        status: 'Disponível', 
                        quantidade: 10
                    }
                ];
                
                empresa1.extintores = [
                    { 
                        id: generateId(), 
                        tipo: 'Pó Químico', 
                        capacidade: '4kg', 
                        localizacao: 'Área Administrativa', 
                        validade: '2024-09-30', 
                        status: 'Aprovado', 
                        proximaInspecao: '2024-04-30'
                    }
                ];
            }
            
            // Dados de exemplo para Empresa 2
            const empresa2 = sistemaData[`empresa_2`];
            if (empresa2.clientes.length === 0) {
                empresa2.clientes = [
                    { 
                        id: generateId(), 
                        nome: 'Cliente B', 
                        cnpj: '98.765.432/0001-10', 
                        email: 'clienteb@email.com', 
                        telefone: '(21) 2222-2222', 
                        responsavel: 'Pedro Almeida',
                        dataCadastro: new Date().toISOString().split('T')[0]
                    }
                ];
                
                empresa2.colaboradores = [
                    { 
                        id: generateId(), 
                        nome: 'Roberto Lima', 
                        cpf: '555.666.777-88', 
                        cargo: 'Auxiliar de Produção', 
                        empresa: 'Cliente B', 
                        epi: 'Sim', 
                        validade: '2024-11-30',
                        dataAdmissao: '2023-03-20'
                    }
                ];
            }
        }
        
        // Dados das NRs
        const normasNR = [
            { numero: 'NR 1', titulo: 'Disposições Gerais', descricao: 'Estabelece o campo de aplicação de todas as Normas Regulamentadoras.' },
            { numero: 'NR 5', titulo: 'CIPA', descricao: 'Comissão Interna de Prevenção de Acidentes.' },
            { numero: 'NR 6', titulo: 'EPI', descricao: 'Equipamentos de Proteção Individual - uso obrigatório.' },
            { numero: 'NR 7', titulo: 'PCMSO', descricao: 'Programa de Controle Médico de Saúde Ocupacional.' },
            { numero: 'NR 9', titulo: 'PPRA', descricao: 'Programa de Prevenção de Riscos Ambientais.' },
            { numero: 'NR 10', titulo: 'Eletricidade', descricao: 'Segurança em instalações e serviços em eletricidade.' },
            { numero: 'NR 12', titulo: 'Máquinas', descricao: 'Segurança no trabalho em máquinas e equipamentos.' },
            { numero: 'NR 15', titulo: 'Atividades Insalubres', descricao: 'Atividades e operações insalubres.' },
            { numero: 'NR 17', titulo: 'Ergonomia', descricao: 'Adaptação das condições de trabalho.' },
            { numero: 'NR 18', titulo: 'Construção Civil', descricao: 'Condições e meio ambiente na indústria da construção.' },
            { numero: 'NR 23', titulo: 'Proteção Contra Incêndios', descricao: 'Medidas de proteção contra incêndios.' },
            { numero: 'NR 33', titulo: 'Espaços Confinados', descricao: 'Segurança e saúde em trabalhos em espaços confinados.' },
            { numero: 'NR 35', titulo: 'Trabalho em Altura', descricao: 'Segurança no trabalho em altura.' }
        ];

        // Funções de Persistência
        function saveToLocalStorage() {
            localStorage.setItem('sistemaData', JSON.stringify(sistemaData));
        }

        function showMessage(type, message) {
            const content = document.getElementById('pageContent');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            if (content.firstChild) {
                content.insertBefore(alertDiv, content.firstChild);
            } else {
                content.appendChild(alertDiv);
            }
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Gerador de IDs
        function generateId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        // Obter dados da empresa atual
        function getCurrentEmpresaData() {
            if (!currentEmpresaId) return null;
            return sistemaData[`empresa_${currentEmpresaId}`] || {
                clientes: [],
                colaboradores: [],
                fornecedores: [],
                epis: [],
                extintores: [],
                inspecoes: []
            };
        }

        // Sistema de Login
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('Por favor, preencha todos os campos!');
                return;
            }
            
            const user = sistemaData.usuarios.find(u => 
                u.username === username && u.password === password
            );
            
            if (user) {
                currentUser = user;
                
                // Inicializar estrutura de dados se necessário
                initializeDataStructure();
                
                // Atualizar informações do usuário
                document.getElementById('currentUserName').textContent = user.nome;
                document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'Administrador' : 'Usuário';
                
                // Mostrar sistema, esconder login
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                
                // Configurar seletor de empresa
                setupEmpresaSelector();
                
                // Carregar dados e dashboard
                loadPage('dashboard');
                
                showMessage('success', `Bem-vindo(a), ${user.nome}!`);
            } else {
                alert('Usuário ou senha incorretos!');
            }
        }

        function setupEmpresaSelector() {
            const empresaSelector = document.getElementById('empresaSelector');
            const empresaSelect = document.getElementById('empresaSelect');
            
            // Limpar opções anteriores
            empresaSelect.innerHTML = '';
            
            // Filtrar empresas que o usuário tem acesso
            const empresasAcesso = sistemaData.empresas.filter(empresa => 
                currentUser.role === 'admin' || currentUser.empresas.includes(empresa.id)
            );
            
            if (empresasAcesso.length === 1) {
                // Se tem acesso a apenas uma empresa, seleciona automaticamente
                empresaSelector.style.display = 'none';
                currentEmpresaId = empresasAcesso[0].id;
                updateEmpresaInfo();
            } else {
                // Se tem acesso a múltiplas empresas, mostrar seletor
                empresaSelector.style.display = 'block';
                
                empresasAcesso.forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa.id;
                    option.textContent = empresa.nome;
                    empresaSelect.appendChild(option);
                });
                
                // Selecionar primeira empresa
                if (empresasAcesso.length > 0) {
                    currentEmpresaId = empresasAcesso[0].id;
                    empresaSelect.value = currentEmpresaId;
                    updateEmpresaInfo();
                }
            }
        }

        function changeEmpresa() {
            const empresaId = parseInt(document.getElementById('empresaSelect').value);
            if (empresaId && empresaId !== currentEmpresaId) {
                currentEmpresaId = empresaId;
                updateEmpresaInfo();
                // Recarregar a página atual
                const activeMenu = document.querySelector('.menu-item.active span');
                if (activeMenu) {
                    loadPage(activeMenu.textContent.toLowerCase());
                }
            }
        }

        function updateEmpresaInfo() {
            const empresa = sistemaData.empresas.find(e => e.id === currentEmpresaId);
            if (empresa) {
                document.getElementById('currentEmpresaNome').textContent = empresa.nome;
                document.getElementById('empresaInfo').textContent = 
                    `${empresa.nome} | CNPJ: ${empresa.cnpj}`;
            }
        }

        function logout() {
            currentUser = null;
            currentEmpresaId = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Sistema de Navegação
        function loadPage(page, event = null) {
            if (!currentEmpresaId && page !== 'empresas' && page !== 'usuarios') {
                showMessage('error', 'Por favor, selecione uma empresa primeiro!');
                return;
            }
            
            // Atualizar menu ativo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (event) {
                event.target.closest('.menu-item').classList.add('active');
            } else {
                // Encontrar o item do menu correspondente à página
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    if (item.querySelector('span').textContent.toLowerCase().includes(page) || 
                        (page === 'dashboard' && item.querySelector('span').textContent === 'Dashboard')) {
                        item.classList.add('active');
                    }
                });
            }
            
            // Carregar conteúdo da página
            const content = document.getElementById('pageContent');
            
            switch(page) {
                case 'dashboard':
                    content.innerHTML = getDashboardHTML();
                    break;
                case 'clientes':
                    content.innerHTML = getClientesHTML();
                    break;
                case 'colaboradores':
                    content.innerHTML = getColaboradoresHTML();
                    break;
                case 'fornecedores':
                    content.innerHTML = getFornecedoresHTML();
                    break;
                case 'epis':
                    content.innerHTML = getEpisHTML();
                    break;
                case 'inspecao-epi':
                    content.innerHTML = getInspecaoEpiHTML();
                    break;
                case 'extintores':
                    content.innerHTML = getExtintoresHTML();
                    break;
                case 'relatorios':
                    content.innerHTML = getRelatoriosHTML();
                    break;
                case 'nrs':
                    content.innerHTML = getNRsHTML();
                    break;
                case 'empresas':
                    if (currentUser.role !== 'admin') {
                        showMessage('error', 'Acesso restrito ao administrador!');
                        loadPage('dashboard');
                        return;
                    }
                    content.innerHTML = getEmpresasHTML();
                    break;
                case 'usuarios':
                    if (currentUser.role !== 'admin') {
                        showMessage('error', 'Acesso restrito ao administrador!');
                        loadPage('dashboard');
                        return;
                    }
                    content.innerHTML = getUsuariosHTML();
                    break;
            }
        }

        // HTML das Páginas
        function getDashboardHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            const hoje = new Date();
            const colaboradoresExpirados = empresaData.colaboradores.filter(c => {
                if (!c.validade) return false;
                const validade = new Date(c.validade);
                return validade < hoje;
            }).length;
            
            const episExpirados = empresaData.epis.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                return validade < hoje;
            }).length;
            
            const extintoresExpirados = empresaData.extintores.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                return validade < hoje;
            }).length;
            
            return `
                <h2 style="margin-bottom: 20px;">Dashboard - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon clientes">
                                <i class="fas fa-building"></i>
                            </div>
                            <span class="badge badge-${empresaData.clientes.length > 0 ? 'success' : 'warning'}">${empresaData.clientes.length}</span>
                        </div>
                        <div class="card-number">${empresaData.clientes.length}</div>
                        <div class="card-label">Clientes Cadastrados</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon colaboradores">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="badge badge-${colaboradoresExpirados > 0 ? 'danger' : 'success'}">${empresaData.colaboradores.length}</span>
                        </div>
                        <div class="card-number">${empresaData.colaboradores.length}</div>
                        <div class="card-label">Colaboradores</div>
                        ${colaboradoresExpirados > 0 ? `
                            <small style="color: #e74c3c; margin-top: 5px;">
                                <i class="fas fa-exclamation-circle"></i> ${colaboradoresExpirados} com EPI vencido
                            </small>
                        ` : ''}
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon epis">
                                <i class="fas fa-hard-hat"></i>
                            </div>
                            <span class="badge badge-${episExpirados > 0 ? 'danger' : 'success'}">${empresaData.epis.length}</span>
                        </div>
                        <div class="card-number">${empresaData.epis.length}</div>
                        <div class="card-label">EPIs Cadastrados</div>
                        ${episExpirados > 0 ? `
                            <small style="color: #e74c3c; margin-top: 5px;">
                                <i class="fas fa-exclamation-circle"></i> ${episExpirados} EPIs vencidos
                            </small>
                        ` : ''}
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon extintores">
                                <i class="fas fa-fire-extinguisher"></i>
                            </div>
                            <span class="badge badge-${extintoresExpirados > 0 ? 'danger' : 'success'}">${empresaData.extintores.length}</span>
                        </div>
                        <div class="card-number">${empresaData.extintores.length}</div>
                        <div class="card-label">Extintores</div>
                        ${extintoresExpirados > 0 ? `
                            <small style="color: #e74c3c; margin-top: 5px;">
                                <i class="fas fa-exclamation-circle"></i> ${extintoresExpirados} extintores vencidos
                            </small>
                        ` : ''}
                    </div>
                </div>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-bell"></i> Alertas Recentes</h3>
                    <ul style="list-style: none; padding: 0;">
                        ${colaboradoresExpirados > 0 ? `
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <i class="fas fa-exclamation-triangle" style="color: #e74c3c; margin-right: 10px;"></i>
                            ${colaboradoresExpirados} colaborador(es) com EPI vencido - Necessária renovação imediata
                        </li>
                        ` : ''}
                        ${episExpirados > 0 ? `
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <i class="fas fa-exclamation-triangle" style="color: #e74c3c; margin-right: 10px;"></i>
                            ${episExpirados} EPI(s) vencido(s) - Necessária substituição
                        </li>
                        ` : ''}
                        ${extintoresExpirados > 0 ? `
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <i class="fas fa-exclamation-triangle" style="color: #e74c3c; margin-right: 10px;"></i>
                            ${extintoresExpirados} extintor(es) vencido(s) - Necessária recarga ou substituição
                        </li>
                        ` : ''}
                        ${empresaData.inspecoes && empresaData.inspecoes.filter(i => {
                            const dataInspecao = new Date(i.data);
                            const diffTime = hoje - dataInspecao;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return diffDays > 180; // Mais de 6 meses
                        }).length > 0 ? `
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                            <i class="fas fa-exclamation-triangle" style="color: #f39c12; margin-right: 10px;"></i>
                            Alguns equipamentos necessitam de nova inspeção (mais de 6 meses)
                        </li>
                        ` : ''}
                        <li style="padding: 10px 0;">
                            <i class="fas fa-info-circle" style="color: #3498db; margin-right: 10px;"></i>
                            Sistema atualizado em ${hoje.toLocaleDateString('pt-BR')}
                        </li>
                    </ul>
                </div>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-chart-line"></i> Estatísticas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3498db;">${empresaData.inspecoes ? empresaData.inspecoes.length : 0}</div>
                            <div style="color: #7f8c8d;">Inspeções Realizadas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${empresaData.epis ? empresaData.epis.filter(e => e.status === 'Disponível').length : 0}</div>
                            <div style="color: #7f8c8d;">EPIs Disponíveis</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${empresaData.fornecedores ? empresaData.fornecedores.length : 0}</div>
                            <div style="color: #7f8c8d;">Fornecedores</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getClientesHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Clientes - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarClientesExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportarClientesPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-primary" onclick="openModal('cliente', null)">
                            <i class="fas fa-plus"></i> Novo Cliente
                        </button>
                    </div>
                </div>
                
                <div class="filters-container mb-3">
                    <div class="filter-group">
                        <label class="form-label">Buscar Cliente</label>
                        <input type="text" class="form-control" id="searchCliente" placeholder="Nome, CNPJ ou responsável..." onkeyup="filtrarClientes()">
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Ordenar por</label>
                        <select class="form-control" id="sortCliente" onchange="filtrarClientes()">
                            <option value="nome">Nome A-Z</option>
                            <option value="nome_desc">Nome Z-A</option>
                            <option value="data">Data Cadastro</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="clientesTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Responsável</th>
                                <th>Telefone</th>
                                <th>E-mail</th>
                                <th>Data Cadastro</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${empresaData.clientes.length > 0 ? empresaData.clientes.map(cliente => `
                                <tr>
                                    <td>${cliente.nome}</td>
                                    <td>${cliente.cnpj}</td>
                                    <td>${cliente.responsavel}</td>
                                    <td>${cliente.telefone}</td>
                                    <td>${cliente.email || '-'}</td>
                                    <td>${cliente.dataCadastro || '-'}</td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-secondary btn-sm" onclick="openModal('cliente', ${cliente.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('cliente', ${cliente.id}, '${cliente.nome}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="7" class="text-center" style="padding: 30px;">
                                        Nenhum cliente cadastrado. Clique em "Novo Cliente" para adicionar.
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getColaboradoresHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Colaboradores - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarColaboradoresExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportarColaboradoresPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-primary" onclick="openModal('colaborador', null)">
                            <i class="fas fa-plus"></i> Novo Colaborador
                        </button>
                    </div>
                </div>
                
                <div class="filters-container mb-3">
                    <div class="filter-group">
                        <label class="form-label">Status EPI</label>
                        <select class="form-control" id="filterEPI" onchange="filtrarColaboradores()">
                            <option value="">Todos</option>
                            <option value="vencido">EPI Vencido</option>
                            <option value="valido">EPI Válido</option>
                            <option value="nao">Sem EPI</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Buscar</label>
                        <input type="text" class="form-control" id="searchColaborador" placeholder="Nome, CPF ou cargo..." onkeyup="filtrarColaboradores()">
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="colaboradoresTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Cargo</th>
                                <th>Empresa</th>
                                <th>EPI</th>
                                <th>Validade</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${empresaData.colaboradores.length > 0 ? empresaData.colaboradores.map(colaborador => {
                                const hoje = new Date();
                                const validade = colaborador.validade ? new Date(colaborador.validade) : null;
                                let status = 'Sem EPI';
                                let badgeClass = 'warning';
                                
                                if (colaborador.epi === 'Sim' && validade) {
                                    const diffTime = validade - hoje;
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    
                                    if (diffDays < 0) {
                                        status = 'Vencido';
                                        badgeClass = 'danger';
                                    } else if (diffDays < 30) {
                                        status = 'Vence em breve';
                                        badgeClass = 'warning';
                                    } else {
                                        status = 'Válido';
                                        badgeClass = 'success';
                                    }
                                } else if (colaborador.epi === 'Não') {
                                    status = 'Sem EPI';
                                    badgeClass = 'warning';
                                }
                                
                                return `
                                    <tr>
                                        <td>${colaborador.nome}</td>
                                        <td>${colaborador.cpf}</td>
                                        <td>${colaborador.cargo}</td>
                                        <td>${colaborador.empresa}</td>
                                        <td>${colaborador.epi}</td>
                                        <td>${colaborador.validade || '-'}</td>
                                        <td><span class="badge badge-${badgeClass}">${status}</span></td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-secondary btn-sm" onclick="openModal('colaborador', ${colaborador.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('colaborador', ${colaborador.id}, '${colaborador.nome}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('') : `
                                <tr>
                                    <td colspan="8" class="text-center" style="padding: 30px;">
                                        Nenhum colaborador cadastrado. Clique em "Novo Colaborador" para adicionar.
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getFornecedoresHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Fornecedores - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarFornecedoresExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-primary" onclick="openModal('fornecedor', null)">
                            <i class="fas fa-plus"></i> Novo Fornecedor
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Contato</th>
                                <th>Telefone</th>
                                <th>E-mail</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${empresaData.fornecedores.length > 0 ? empresaData.fornecedores.map(fornecedor => `
                                <tr>
                                    <td>${fornecedor.nome}</td>
                                    <td><span class="badge badge-info">${fornecedor.tipo}</span></td>
                                    <td>${fornecedor.contato}</td>
                                    <td>${fornecedor.telefone}</td>
                                    <td>${fornecedor.email || '-'}</td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-secondary btn-sm" onclick="openModal('fornecedor', ${fornecedor.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('fornecedor', ${fornecedor.id}, '${fornecedor.nome}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 30px;">
                                        Nenhum fornecedor cadastrado. Clique em "Novo Fornecedor" para adicionar.
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getEpisHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Equipamentos de Proteção Individual - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarEPIsExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportarEPIsPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-primary" onclick="openModal('epi', null)">
                            <i class="fas fa-plus"></i> Novo EPI
                        </button>
                    </div>
                </div>
                
                <div class="filters-container mb-3">
                    <div class="filter-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="filterStatusEPI" onchange="filtrarEPIs()">
                            <option value="">Todos</option>
                            <option value="Disponível">Disponível</option>
                            <option value="Em uso">Em uso</option>
                            <option value="Manutenção">Manutenção</option>
                            <option value="Descartado">Descartado</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Tipo</label>
                        <select class="form-control" id="filterTipoEPI" onchange="filtrarEPIs()">
                            <option value="">Todos</option>
                            <option value="Capacete">Capacete</option>
                            <option value="Óculos de Proteção">Óculos de Proteção</option>
                            <option value="Protetor Auricular">Protetor Auricular</option>
                            <option value="Máscara">Máscara</option>
                            <option value="Luvas">Luvas</option>
                            <option value="Calçado de Segurança">Calçado de Segurança</option>
                            <option value="Cinto de Segurança">Cinto de Segurança</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="episTable">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Marca</th>
                                <th>Lote</th>
                                <th>Quantidade</th>
                                <th>Validade</th>
                                <th>Status</th>
                                <th>Dias para Vencer</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${empresaData.epis.length > 0 ? empresaData.epis.map(epi => {
                                const hoje = new Date();
                                const validade = epi.validade ? new Date(epi.validade) : null;
                                let diasParaVencer = null;
                                let statusClass = '';
                                
                                if (validade) {
                                    const diffTime = validade - hoje;
                                    diasParaVencer = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    
                                    if (diasParaVencer < 0) {
                                        statusClass = 'danger';
                                    } else if (diasParaVencer < 30) {
                                        statusClass = 'warning';
                                    } else {
                                        statusClass = 'success';
                                    }
                                }
                                
                                return `
                                    <tr>
                                        <td>${epi.tipo}</td>
                                        <td>${epi.marca}</td>
                                        <td>${epi.lote}</td>
                                        <td>${epi.quantidade || 0}</td>
                                        <td>${epi.validade || '-'}</td>
                                        <td><span class="badge badge-${statusClass}">${epi.status}</span></td>
                                        <td>
                                            ${diasParaVencer !== null ? `
                                                <span class="${diasParaVencer < 0 ? 'text-danger' : diasParaVencer < 30 ? 'text-warning' : 'text-success'}">
                                                    ${diasParaVencer < 0 ? 'Vencido' : `${diasParaVencer} dias`}
                                                </span>
                                            ` : '-'}
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-secondary btn-sm" onclick="openModal('epi', ${epi.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-warning btn-sm" onclick="inspecionarEPI(${epi.id})">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('') : `
                                <tr>
                                    <td colspan="8" class="text-center" style="padding: 30px;">
                                        Nenhum EPI cadastrado. Clique em "Novo EPI" para adicionar.
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getInspecaoEpiHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-search"></i> Inspeção de EPIs - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Selecione o EPI para Inspeção</label>
                        <select class="form-control" id="epiSelect">
                            <option value="">Selecione um EPI</option>
                            ${empresaData.epis.map(epi => `
                                <option value="${epi.id}">${epi.tipo} - ${epi.marca} (Lote: ${epi.lote})</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data da Inspeção</label>
                        <input type="date" class="form-control" id="dataInspecao" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Condição do EPI</label>
                        <select class="form-control" id="condicaoEPI">
                            <option value="Aprovado">Aprovado</option>
                            <option value="Reprovado">Reprovado</option>
                            <option value="Manutenção">Necessita Manutenção</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" rows="3" placeholder="Descreva as condições do EPI..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Inspetor Responsável</label>
                        <input type="text" class="form-control" id="inspetor" value="${currentUser.nome}" readonly>
                    </div>
                    
                    <button class="btn btn-primary" onclick="registrarInspecao()">
                        <i class="fas fa-save"></i> Registrar Inspeção
                    </button>
                </div>
                
                <div class="form-container">
                    <div class="d-flex justify-between align-center mb-3">
                        <h3 class="form-title"><i class="fas fa-history"></i> Histórico de Inspeções</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="exportarInspecoesExcel()">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn btn-danger" onclick="exportarInspecoesPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    
                    ${empresaData.inspecoes && empresaData.inspecoes.length > 0 ? `
                        <div class="table-container">
                            <table id="inspecoesTable">
                                <thead>
                                    <tr>
                                        <th>EPI</th>
                                        <th>Data</th>
                                        <th>Condição</th>
                                        <th>Inspetor</th>
                                        <th>Observações</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${empresaData.inspecoes.map(inspecao => `
                                        <tr>
                                            <td>${inspecao.epiNome}</td>
                                            <td>${inspecao.data}</td>
                                            <td><span class="badge badge-${inspecao.condicao === 'Aprovado' ? 'success' : inspecao.condicao === 'Reprovado' ? 'danger' : 'warning'}">${inspecao.condicao}</span></td>
                                            <td>${inspecao.inspetor}</td>
                                            <td>${inspecao.observacoes || '-'}</td>
                                            <td>
                                                <button class="btn btn-info btn-sm" onclick="visualizarInspecao(${inspecao.id})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">
                            Nenhuma inspeção registrada ainda.
                        </p>
                    `}
                </div>
            `;
        }

        function getExtintoresHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Extintores - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarExtintoresExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-primary" onclick="openModal('extintor', null)">
                            <i class="fas fa-plus"></i> Novo Extintor
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Capacidade</th>
                                <th>Localização</th>
                                <th>Validade</th>
                                <th>Próxima Inspeção</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${empresaData.extintores.length > 0 ? empresaData.extintores.map(extintor => {
                                const hoje = new Date();
                                const validade = extintor.validade ? new Date(extintor.validade) : null;
                                let statusClass = '';
                                
                                if (validade) {
                                    const diffTime = validade - hoje;
                                    const diasParaVencer = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    
                                    if (diasParaVencer < 0) {
                                        statusClass = 'danger';
                                    } else if (diasParaVencer < 30) {
                                        statusClass = 'warning';
                                    } else {
                                        statusClass = 'success';
                                    }
                                }
                                
                                return `
                                    <tr>
                                        <td>${extintor.tipo}</td>
                                        <td>${extintor.capacidade}</td>
                                        <td>${extintor.localizacao}</td>
                                        <td>${extintor.validade}</td>
                                        <td>${extintor.proximaInspecao || '-'}</td>
                                        <td><span class="badge badge-${statusClass}">${extintor.status}</span></td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-secondary btn-sm" onclick="openModal('extintor', ${extintor.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="inspecionarExtintor(${extintor.id})">
                                                    <i class="fas fa-fire-extinguisher"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('') : `
                                <tr>
                                    <td colspan="7" class="text-center" style="padding: 30px;">
                                        Nenhum extintor cadastrado. Clique em "Novo Extintor" para adicionar.
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getRelatoriosHTML() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return '';
            
            return `
                <h2 style="margin-bottom: 20px;">Relatórios - ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}</h2>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-chart-bar"></i> Relatórios Disponíveis</h3>
                    
                    <div class="report-options">
                        <div class="report-card" onclick="gerarRelatorioCompletoExcel()">
                            <div class="report-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <h3>Relatório Completo (Excel)</h3>
                            <p>Exporta todos os dados da empresa para Excel</p>
                            <button class="btn btn-success w-100">
                                <i class="fas fa-download"></i> Gerar Excel
                            </button>
                        </div>
                        
                        <div class="report-card" onclick="gerarRelatorioCompletoPDF()">
                            <div class="report-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <h3>Relatório Completo (PDF)</h3>
                            <p>Exporta todos os dados da empresa para PDF</p>
                            <button class="btn btn-danger w-100">
                                <i class="fas fa-download"></i> Gerar PDF
                            </button>
                        </div>
                        
                        <div class="report-card" onclick="gerarRelatorioInspecoes()">
                            <div class="report-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3>Relatório de Inspeções</h3>
                            <p>Histórico completo de inspeções de EPIs</p>
                            <button class="btn btn-info w-100">
                                <i class="fas fa-download"></i> Gerar Relatório
                            </button>
                        </div>
                        
                        <div class="report-card" onclick="gerarRelatorioVencimentos()">
                            <div class="report-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>Relatório de Vencimentos</h3>
                            <p>EPIs e colaboradores com vencimentos próximos</p>
                            <button class="btn btn-warning w-100">
                                <i class="fas fa-download"></i> Gerar Relatório
                            </button>
                        </div>
                        
                        <div class="report-card" onclick="gerarRelatorioEstatisticas()">
                            <div class="report-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h3>Relatório Estatístico</h3>
                            <p>Estatísticas e métricas da empresa</p>
                            <button class="btn btn-primary w-100">
                                <i class="fas fa-download"></i> Gerar Relatório
                            </button>
                        </div>
                        
                        <div class="report-card" onclick="gerarRelatorioCompliance()">
                            <div class="report-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3>Relatório de Compliance</h3>
                            <p>Conformidade com normas regulamentadoras</p>
                            <button class="btn btn-secondary w-100">
                                <i class="fas fa-download"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-container">
                    <h3 class="form-title"><i class="fas fa-cogs"></i> Relatórios Personalizados</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Relatório</label>
                        <select class="form-control" id="tipoRelatorio">
                            <option value="">Selecione um tipo</option>
                            <option value="clientes">Clientes</option>
                            <option value="colaboradores">Colaboradores</option>
                            <option value="epis">EPIs</option>
                            <option value="inspecoes">Inspeções</option>
                            <option value="extintores">Extintores</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Período (opcional)</label>
                        <div class="d-flex gap-2">
                            <input type="date" class="form-control" id="dataInicio" placeholder="Data início">
                            <input type="date" class="form-control" id="dataFim" placeholder="Data fim">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Formato</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="gerarRelatorioPersonalizado('excel')">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn btn-danger" onclick="gerarRelatorioPersonalizado('pdf')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getNRsHTML() {
            return `
                <h2 style="margin-bottom: 20px;">Normas Regulamentadoras (NRs)</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Lista completa das Normas Regulamentadoras de Segurança e Saúde no Trabalho
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    ${normasNR.map(nr => `
                        <div class="card">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: #3498db; color: white; padding: 10px; border-radius: 8px; font-weight: bold;">
                                    ${nr.numero}
                                </div>
                                <div>
                                    <h3 style="margin-bottom: 5px;">${nr.titulo}</h3>
                                    <p style="color: #7f8c8d; font-size: 14px;">${nr.descricao}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getEmpresasHTML() {
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Empresas</h2>
                    <button class="btn btn-primary" onclick="openModal('empresa', null)">
                        <i class="fas fa-plus"></i> Nova Empresa
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Responsável</th>
                                <th>Telefone</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sistemaData.empresas.map(empresa => `
                                <tr>
                                    <td>${empresa.nome}</td>
                                    <td>${empresa.cnpj}</td>
                                    <td>${empresa.responsavel}</td>
                                    <td>${empresa.telefone}</td>
                                    <td><span class="badge ${empresa.status === 'Ativa' ? 'badge-success' : 'badge-danger'}">${empresa.status}</span></td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-secondary btn-sm" onclick="openModal('empresa', ${empresa.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${empresa.id > 2 ? `
                                                <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('empresa', ${empresa.id}, '${empresa.nome}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getUsuariosHTML() {
            return `
                <div class="d-flex justify-between align-center mb-3">
                    <h2>Usuários do Sistema</h2>
                    <button class="btn btn-primary" onclick="openModal('usuario', null)">
                        <i class="fas fa-plus"></i> Novo Usuário
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Usuário</th>
                                <th>Tipo</th>
                                <th>Empresas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sistemaData.usuarios.map(usuario => {
                                const empresas = usuario.empresas ? 
                                    usuario.empresas.map(id => 
                                        sistemaData.empresas.find(e => e.id === id)?.nome || id
                                    ).join(', ') : 'Todas';
                                
                                return `
                                    <tr>
                                        <td>${usuario.nome}</td>
                                        <td>${usuario.username}</td>
                                        <td><span class="badge ${usuario.role === 'admin' ? 'badge-warning' : 'badge-success'}">${usuario.role === 'admin' ? 'Administrador' : 'Usuário'}</span></td>
                                        <td>${usuario.role === 'admin' ? 'Todas' : empresas}</td>
                                        <td>
                                            ${usuario.id !== 1 ? `
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-secondary btn-sm" onclick="openModal('usuario', ${usuario.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('usuario', ${usuario.id}, '${usuario.nome}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            ` : '<small style="color: #7f8c8d;">Administrador principal</small>'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Funções de Modal
        function openModal(tipo, id = null) {
            editingId = id;
            document.getElementById('modal').style.display = 'flex';
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            let dados = {};
            if (id) {
                switch(tipo) {
                    case 'cliente':
                        const empresaData = getCurrentEmpresaData();
                        dados = empresaData ? empresaData.clientes.find(c => c.id === id) || {} : {};
                        break;
                    case 'colaborador':
                        const empresaData2 = getCurrentEmpresaData();
                        dados = empresaData2 ? empresaData2.colaboradores.find(c => c.id === id) || {} : {};
                        break;
                    case 'fornecedor':
                        const empresaData3 = getCurrentEmpresaData();
                        dados = empresaData3 ? empresaData3.fornecedores.find(f => f.id === id) || {} : {};
                        break;
                    case 'epi':
                        const empresaData4 = getCurrentEmpresaData();
                        dados = empresaData4 ? empresaData4.epis.find(e => e.id === id) || {} : {};
                        break;
                    case 'extintor':
                        const empresaData5 = getCurrentEmpresaData();
                        dados = empresaData5 ? empresaData5.extintores.find(e => e.id === id) || {} : {};
                        break;
                    case 'empresa':
                        dados = sistemaData.empresas.find(e => e.id === id) || {};
                        break;
                    case 'usuario':
                        dados = sistemaData.usuarios.find(u => u.id === id) || {};
                        break;
                }
            }
            
            switch(tipo) {
                case 'cliente':
                    modalTitle.innerHTML = `<i class="fas fa-building"></i> ${id ? 'Editar' : 'Novo'} Cliente`;
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Nome da Empresa *</label>
                            <input type="text" class="form-control" id="clienteNome" value="${dados.nome || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CNPJ *</label>
                            <input type="text" class="form-control" id="clienteCNPJ" value="${dados.cnpj || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Responsável *</label>
                            <input type="text" class="form-control" id="clienteResponsavel" value="${dados.responsavel || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone *</label>
                            <input type="text" class="form-control" id="clienteTelefone" value="${dados.telefone || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="clienteEmail" value="${dados.email || ''}">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarCliente()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'colaborador':
                    modalTitle.innerHTML = `<i class="fas fa-user"></i> ${id ? 'Editar' : 'Novo'} Colaborador`;
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="colaboradorNome" value="${dados.nome || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF *</label>
                            <input type="text" class="form-control" id="colaboradorCPF" value="${dados.cpf || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cargo *</label>
                            <input type="text" class="form-control" id="colaboradorCargo" value="${dados.cargo || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Empresa *</label>
                            <input type="text" class="form-control" id="colaboradorEmpresa" value="${dados.empresa || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de Admissão</label>
                            <input type="date" class="form-control" id="colaboradorDataAdmissao" value="${dados.dataAdmissao || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">EPI</label>
                            <select class="form-control" id="colaboradorEPI">
                                <option value="Sim" ${dados.epi === 'Sim' ? 'selected' : ''}>Sim</option>
                                <option value="Não" ${dados.epi === 'Não' ? 'selected' : ''}>Não</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Validade do EPI</label>
                            <input type="date" class="form-control" id="colaboradorValidade" value="${dados.validade || ''}">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarColaborador()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'fornecedor':
                    modalTitle.innerHTML = `<i class="fas fa-truck"></i> ${id ? 'Editar' : 'Novo'} Fornecedor`;
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Nome do Fornecedor *</label>
                            <input type="text" class="form-control" id="fornecedorNome" value="${dados.nome || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo *</label>
                            <select class="form-control" id="fornecedorTipo" required>
                                <option value="EPIs" ${dados.tipo === 'EPIs' ? 'selected' : ''}>EPIs</option>
                                <option value="Extintores" ${dados.tipo === 'Extintores' ? 'selected' : ''}>Extintores</option>
                                <option value="Treinamentos" ${dados.tipo === 'Treinamentos' ? 'selected' : ''}>Treinamentos</option>
                                <option value="Outros" ${dados.tipo === 'Outros' ? 'selected' : ''}>Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contato *</label>
                            <input type="text" class="form-control" id="fornecedorContato" value="${dados.contato || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone *</label>
                            <input type="text" class="form-control" id="fornecedorTelefone" value="${dados.telefone || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="fornecedorEmail" value="${dados.email || ''}">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarFornecedor()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'epi':
                    modalTitle.innerHTML = `<i class="fas fa-hard-hat"></i> ${id ? 'Editar' : 'Novo'} EPI`;
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Tipo de EPI *</label>
                            <select class="form-control" id="epiTipo" required>
                                <option value="Capacete" ${dados.tipo === 'Capacete' ? 'selected' : ''}>Capacete</option>
                                <option value="Óculos de Proteção" ${dados.tipo === 'Óculos de Proteção' ? 'selected' : ''}>Óculos de Proteção</option>
                                <option value="Protetor Auricular" ${dados.tipo === 'Protetor Auricular' ? 'selected' : ''}>Protetor Auricular</option>
                                <option value="Máscara" ${dados.tipo === 'Máscara' ? 'selected' : ''}>Máscara</option>
                                <option value="Luvas" ${dados.tipo === 'Luvas' ? 'selected' : ''}>Luvas</option>
                                <option value="Calçado de Segurança" ${dados.tipo === 'Calçado de Segurança' ? 'selected' : ''}>Calçado de Segurança</option>
                                <option value="Cinto de Segurança" ${dados.tipo === 'Cinto de Segurança' ? 'selected' : ''}>Cinto de Segurança</option>
                                <option value="Outros" ${dados.tipo === 'Outros' ? 'selected' : ''}>Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marca *</label>
                            <input type="text" class="form-control" id="epiMarca" value="${dados.marca || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lote *</label>
                            <input type="text" class="form-control" id="epiLote" value="${dados.lote || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantidade *</label>
                            <input type="number" class="form-control" id="epiQuantidade" value="${dados.quantidade || 0}" required min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Validade *</label>
                            <input type="date" class="form-control" id="epiValidade" value="${dados.validade || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-control" id="epiStatus" required>
                                <option value="Disponível" ${dados.status === 'Disponível' ? 'selected' : ''}>Disponível</option>
                                <option value="Em uso" ${dados.status === 'Em uso' ? 'selected' : ''}>Em uso</option>
                                <option value="Manutenção" ${dados.status === 'Manutenção' ? 'selected' : ''}>Manutenção</option>
                                <option value="Descartado" ${dados.status === 'Descartado' ? 'selected' : ''}>Descartado</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarEPI()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'extintor':
                    modalTitle.innerHTML = `<i class="fas fa-fire-extinguisher"></i> ${id ? 'Editar' : 'Novo'} Extintor`;
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Tipo *</label>
                            <select class="form-control" id="extintorTipo" required>
                                <option value="Pó Químico" ${dados.tipo === 'Pó Químico' ? 'selected' : ''}>Pó Químico</option>
                                <option value="CO2" ${dados.tipo === 'CO2' ? 'selected' : ''}>CO2</option>
                                <option value="Água" ${dados.tipo === 'Água' ? 'selected' : ''}>Água</option>
                                <option value="Espuma" ${dados.tipo === 'Espuma' ? 'selected' : ''}>Espuma</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Capacidade *</label>
                            <input type="text" class="form-control" id="extintorCapacidade" value="${dados.capacidade || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Localização *</label>
                            <input type="text" class="form-control" id="extintorLocalizacao" value="${dados.localizacao || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Validade *</label>
                            <input type="date" class="form-control" id="extintorValidade" value="${dados.validade || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Próxima Inspeção</label>
                            <input type="date" class="form-control" id="extintorProximaInspecao" value="${dados.proximaInspecao || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-control" id="extintorStatus" required>
                                <option value="Aprovado" ${dados.status === 'Aprovado' ? 'selected' : ''}>Aprovado</option>
                                <option value="Inspecionar" ${dados.status === 'Inspecionar' ? 'selected' : ''}>Inspecionar</option>
                                <option value="Reprovado" ${dados.status === 'Reprovado' ? 'selected' : ''}>Reprovado</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarExtintor()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'empresa':
                    modalTitle.innerHTML = `<i class="fas fa-industry"></i> ${id ? 'Editar' : 'Nova'} Empresa`;
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Nome da Empresa *</label>
                            <input type="text" class="form-control" id="empresaNome" value="${dados.nome || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CNPJ *</label>
                            <input type="text" class="form-control" id="empresaCNPJ" value="${dados.cnpj || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Responsável *</label>
                            <input type="text" class="form-control" id="empresaResponsavel" value="${dados.responsavel || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone *</label>
                            <input type="text" class="form-control" id="empresaTelefone" value="${dados.telefone || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="empresaEmail" value="${dados.email || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-control" id="empresaStatus" required>
                                <option value="Ativa" ${dados.status === 'Ativa' ? 'selected' : ''}>Ativa</option>
                                <option value="Inativa" ${dados.status === 'Inativa' ? 'selected' : ''}>Inativa</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarEmpresa()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'usuario':
                    modalTitle.innerHTML = `<i class="fas fa-user-plus"></i> ${id ? 'Editar' : 'Novo'} Usuário`;
                    
                    let empresasHTML = '';
                    if (sistemaData.empresas) {
                        empresasHTML = sistemaData.empresas.map(empresa => {
                            const isSelected = dados.empresas ? dados.empresas.includes(empresa.id) : false;
                            return `
                                <div>
                                    <input type="checkbox" id="empresa_${empresa.id}" value="${empresa.id}" ${isSelected ? 'checked' : ''}>
                                    <label for="empresa_${empresa.id}">${empresa.nome}</label>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="usuarioNome" value="${dados.nome || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome de Usuário *</label>
                            <input type="text" class="form-control" id="usuarioUsername" value="${dados.username || ''}" required ${id ? 'readonly' : ''}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Senha ${id ? '(deixe em branco para não alterar)' : '*'} </label>
                            <input type="password" class="form-control" id="usuarioSenha" ${id ? '' : 'required'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Usuário *</label>
                            <select class="form-control" id="usuarioTipo" required onchange="toggleEmpresas(this.value)">
                                <option value="user" ${dados.role === 'user' ? 'selected' : ''}>Usuário</option>
                                <option value="admin" ${dados.role === 'admin' ? 'selected' : ''}>Administrador</option>
                            </select>
                        </div>
                        <div class="form-group" id="empresasUsuarioGroup" style="${dados.role === 'admin' ? 'display: none;' : ''}">
                            <label class="form-label">Empresas com Acesso *</label>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px;">
                                ${empresasHTML}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" onclick="salvarUsuario()">
                                <i class="fas fa-save"></i> ${id ? 'Atualizar' : 'Salvar'}
                            </button>
                        </div>
                    `;
                    break;
                    
                default:
                    modalTitle.textContent = 'Funcionalidade em Desenvolvimento';
                    modalBody.innerHTML = `
                        <p style="text-align: center; padding: 20px;">
                            Esta funcionalidade está em desenvolvimento.<br>
                            No sistema completo, você poderá realizar esta operação.
                        </p>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    `;
            }
        }

        function toggleEmpresas(tipo) {
            const empresasGroup = document.getElementById('empresasUsuarioGroup');
            if (tipo === 'admin') {
                empresasGroup.style.display = 'none';
            } else {
                empresasGroup.style.display = 'block';
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            editingId = null;
        }

        // Funções de Salvar/Atualizar
        function salvarCliente() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const nome = document.getElementById('clienteNome').value;
            const cnpj = document.getElementById('clienteCNPJ').value;
            const responsavel = document.getElementById('clienteResponsavel').value;
            const telefone = document.getElementById('clienteTelefone').value;
            const email = document.getElementById('clienteEmail').value;
            
            if (!nome || !cnpj || !responsavel || !telefone) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const cliente = {
                id: editingId || generateId(),
                nome,
                cnpj,
                responsavel,
                telefone,
                email,
                dataCadastro: editingId ? (empresaData.clientes.find(c => c.id === editingId)?.dataCadastro || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0]
            };
            
            if (editingId) {
                const index = empresaData.clientes.findIndex(c => c.id === editingId);
                if (index !== -1) {
                    empresaData.clientes[index] = cliente;
                    showMessage('success', 'Cliente atualizado com sucesso!');
                }
            } else {
                empresaData.clientes.push(cliente);
                showMessage('success', 'Cliente cadastrado com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('clientes');
        }

        function salvarColaborador() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const nome = document.getElementById('colaboradorNome').value;
            const cpf = document.getElementById('colaboradorCPF').value;
            const cargo = document.getElementById('colaboradorCargo').value;
            const empresa = document.getElementById('colaboradorEmpresa').value;
            const dataAdmissao = document.getElementById('colaboradorDataAdmissao').value;
            const epi = document.getElementById('colaboradorEPI').value;
            const validade = document.getElementById('colaboradorValidade').value;
            
            if (!nome || !cpf || !cargo || !empresa) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const colaborador = {
                id: editingId || generateId(),
                nome,
                cpf,
                cargo,
                empresa,
                dataAdmissao,
                epi,
                validade
            };
            
            if (editingId) {
                const index = empresaData.colaboradores.findIndex(c => c.id === editingId);
                if (index !== -1) {
                    empresaData.colaboradores[index] = colaborador;
                    showMessage('success', 'Colaborador atualizado com sucesso!');
                }
            } else {
                empresaData.colaboradores.push(colaborador);
                showMessage('success', 'Colaborador cadastrado com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('colaboradores');
        }

        function salvarFornecedor() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const nome = document.getElementById('fornecedorNome').value;
            const tipo = document.getElementById('fornecedorTipo').value;
            const contato = document.getElementById('fornecedorContato').value;
            const telefone = document.getElementById('fornecedorTelefone').value;
            const email = document.getElementById('fornecedorEmail').value;
            
            if (!nome || !tipo || !contato || !telefone) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const fornecedor = {
                id: editingId || generateId(),
                nome,
                tipo,
                contato,
                telefone,
                email
            };
            
            if (editingId) {
                const index = empresaData.fornecedores.findIndex(f => f.id === editingId);
                if (index !== -1) {
                    empresaData.fornecedores[index] = fornecedor;
                    showMessage('success', 'Fornecedor atualizado com sucesso!');
                }
            } else {
                empresaData.fornecedores.push(fornecedor);
                showMessage('success', 'Fornecedor cadastrado com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('fornecedores');
        }

        function salvarEPI() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const tipo = document.getElementById('epiTipo').value;
            const marca = document.getElementById('epiMarca').value;
            const lote = document.getElementById('epiLote').value;
            const quantidade = parseInt(document.getElementById('epiQuantidade').value);
            const validade = document.getElementById('epiValidade').value;
            const status = document.getElementById('epiStatus').value;
            
            if (!tipo || !marca || !lote || !quantidade || !validade || !status) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const epi = {
                id: editingId || generateId(),
                tipo,
                marca,
                lote,
                quantidade,
                validade,
                status
            };
            
            if (editingId) {
                const index = empresaData.epis.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    empresaData.epis[index] = epi;
                    showMessage('success', 'EPI atualizado com sucesso!');
                }
            } else {
                empresaData.epis.push(epi);
                showMessage('success', 'EPI cadastrado com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('epis');
        }

        function salvarExtintor() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const tipo = document.getElementById('extintorTipo').value;
            const capacidade = document.getElementById('extintorCapacidade').value;
            const localizacao = document.getElementById('extintorLocalizacao').value;
            const validade = document.getElementById('extintorValidade').value;
            const proximaInspecao = document.getElementById('extintorProximaInspecao').value;
            const status = document.getElementById('extintorStatus').value;
            
            if (!tipo || !capacidade || !localizacao || !validade || !status) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const extintor = {
                id: editingId || generateId(),
                tipo,
                capacidade,
                localizacao,
                validade,
                proximaInspecao,
                status
            };
            
            if (editingId) {
                const index = empresaData.extintores.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    empresaData.extintores[index] = extintor;
                    showMessage('success', 'Extintor atualizado com sucesso!');
                }
            } else {
                empresaData.extintores.push(extintor);
                showMessage('success', 'Extintor cadastrado com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('extintores');
        }

        function salvarEmpresa() {
            const nome = document.getElementById('empresaNome').value;
            const cnpj = document.getElementById('empresaCNPJ').value;
            const responsavel = document.getElementById('empresaResponsavel').value;
            const telefone = document.getElementById('empresaTelefone').value;
            const email = document.getElementById('empresaEmail').value;
            const status = document.getElementById('empresaStatus').value;
            
            if (!nome || !cnpj || !responsavel || !telefone || !status) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const empresa = {
                id: editingId || generateId(),
                nome,
                cnpj,
                responsavel,
                telefone,
                email,
                status
            };
            
            if (editingId) {
                const index = sistemaData.empresas.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    sistemaData.empresas[index] = empresa;
                    showMessage('success', 'Empresa atualizada com sucesso!');
                }
            } else {
                sistemaData.empresas.push(empresa);
                // Criar estrutura de dados para a nova empresa
                sistemaData[`empresa_${empresa.id}`] = {
                    clientes: [],
                    colaboradores: [],
                    fornecedores: [],
                    epis: [],
                    extintores: [],
                    inspecoes: []
                };
                showMessage('success', 'Empresa cadastrada com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('empresas');
        }

        function salvarUsuario() {
            const nome = document.getElementById('usuarioNome').value;
            const username = document.getElementById('usuarioUsername').value;
            const senha = document.getElementById('usuarioSenha').value;
            const tipo = document.getElementById('usuarioTipo').value;
            
            if (!nome || !username || (!editingId && !senha) || !tipo) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Verificar se o nome de usuário já existe (apenas para novos usuários)
            if (!editingId && sistemaData.usuarios.some(u => u.username === username)) {
                showMessage('error', 'Este nome de usuário já está em uso!');
                return;
            }
            
            // Coletar empresas selecionadas (apenas para usuários não-admin)
            let empresas = [];
            if (tipo === 'user') {
                const checkboxes = document.querySelectorAll('#empresasUsuarioGroup input[type="checkbox"]:checked');
                empresas = Array.from(checkboxes).map(cb => parseInt(cb.value));
                
                if (empresas.length === 0) {
                    showMessage('error', 'Selecione pelo menos uma empresa para o usuário!');
                    return;
                }
            } else {
                // Admin tem acesso a todas as empresas
                empresas = sistemaData.empresas.map(e => e.id);
            }
            
            const usuario = {
                id: editingId || generateId(),
                nome,
                username,
                password: editingId && !senha ? sistemaData.usuarios.find(u => u.id === editingId)?.password : senha,
                role: tipo,
                empresas
            };
            
            if (editingId) {
                const index = sistemaData.usuarios.findIndex(u => u.id === editingId);
                if (index !== -1) {
                    sistemaData.usuarios[index] = usuario;
                    showMessage('success', 'Usuário atualizado com sucesso!');
                }
            } else {
                sistemaData.usuarios.push(usuario);
                showMessage('success', 'Usuário cadastrado com sucesso!');
            }
            
            saveToLocalStorage();
            closeModal();
            loadPage('usuarios');
        }

        // Funções de Exclusão
        function confirmarExclusao(tipo, id, nome) {
            if (!confirm(`Tem certeza que deseja excluir "${nome}"? Esta ação não pode ser desfeita.`)) {
                return;
            }
            
            switch(tipo) {
                case 'cliente':
                    const empresaData = getCurrentEmpresaData();
                    if (empresaData) {
                        empresaData.clientes = empresaData.clientes.filter(c => c.id !== id);
                        showMessage('success', 'Cliente excluído com sucesso!');
                        loadPage('clientes');
                    }
                    break;
                case 'colaborador':
                    const empresaData2 = getCurrentEmpresaData();
                    if (empresaData2) {
                        empresaData2.colaboradores = empresaData2.colaboradores.filter(c => c.id !== id);
                        showMessage('success', 'Colaborador excluído com sucesso!');
                        loadPage('colaboradores');
                    }
                    break;
                case 'fornecedor':
                    const empresaData3 = getCurrentEmpresaData();
                    if (empresaData3) {
                        empresaData3.fornecedores = empresaData3.fornecedores.filter(f => f.id !== id);
                        showMessage('success', 'Fornecedor excluído com sucesso!');
                        loadPage('fornecedores');
                    }
                    break;
                case 'empresa':
                    // Não permitir excluir as empresas padrão
                    if (id <= 2) {
                        showMessage('error', 'Não é possível excluir as empresas padrão do sistema!');
                        return;
                    }
                    sistemaData.empresas = sistemaData.empresas.filter(e => e.id !== id);
                    // Remover os dados da empresa
                    delete sistemaData[`empresa_${id}`];
                    showMessage('success', 'Empresa excluída com sucesso!');
                    loadPage('empresas');
                    break;
                case 'usuario':
                    if (id === 1) {
                        showMessage('error', 'Não é possível excluir o administrador principal!');
                        return;
                    }
                    sistemaData.usuarios = sistemaData.usuarios.filter(u => u.id !== id);
                    showMessage('success', 'Usuário excluído com sucesso!');
                    loadPage('usuarios');
                    break;
            }
            
            saveToLocalStorage();
        }

        // Funções de Filtro
        function filtrarClientes() {
            const search = document.getElementById('searchCliente').value.toLowerCase();
            const sort = document.getElementById('sortCliente').value;
            const empresaData = getCurrentEmpresaData();
            
            if (!empresaData) return;
            
            let clientesFiltrados = empresaData.clientes.filter(cliente => 
                cliente.nome.toLowerCase().includes(search) ||
                cliente.cnpj.includes(search) ||
                cliente.responsavel.toLowerCase().includes(search) ||
                cliente.email?.toLowerCase().includes(search)
            );
            
            // Ordenação
            switch(sort) {
                case 'nome':
                    clientesFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));
                    break;
                case 'nome_desc':
                    clientesFiltrados.sort((a, b) => b.nome.localeCompare(a.nome));
                    break;
                case 'data':
                    clientesFiltrados.sort((a, b) => new Date(b.dataCadastro) - new Date(a.dataCadastro));
                    break;
            }
            
            // Atualizar tabela
            const tbody = document.querySelector('#clientesTable tbody');
            if (tbody) {
                tbody.innerHTML = clientesFiltrados.map(cliente => `
                    <tr>
                        <td>${cliente.nome}</td>
                        <td>${cliente.cnpj}</td>
                        <td>${cliente.responsavel}</td>
                        <td>${cliente.telefone}</td>
                        <td>${cliente.email || '-'}</td>
                        <td>${cliente.dataCadastro || '-'}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="btn btn-secondary btn-sm" onclick="openModal('cliente', ${cliente.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('cliente', ${cliente.id}, '${cliente.nome}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                if (clientesFiltrados.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center" style="padding: 30px;">
                                Nenhum cliente encontrado com os filtros aplicados.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function filtrarColaboradores() {
            const filterEPI = document.getElementById('filterEPI').value;
            const search = document.getElementById('searchColaborador').value.toLowerCase();
            const empresaData = getCurrentEmpresaData();
            
            if (!empresaData) return;
            
            const hoje = new Date();
            let colaboradoresFiltrados = empresaData.colaboradores.filter(colaborador => {
                // Filtro de busca
                const matchSearch = 
                    colaborador.nome.toLowerCase().includes(search) ||
                    colaborador.cpf.includes(search) ||
                    colaborador.cargo.toLowerCase().includes(search) ||
                    colaborador.empresa.toLowerCase().includes(search);
                
                if (!matchSearch) return false;
                
                // Filtro de status EPI
                if (!filterEPI) return true;
                
                if (filterEPI === 'vencido') {
                    if (colaborador.epi !== 'Sim' || !colaborador.validade) return false;
                    const validade = new Date(colaborador.validade);
                    return validade < hoje;
                }
                
                if (filterEPI === 'valido') {
                    if (colaborador.epi !== 'Sim' || !colaborador.validade) return false;
                    const validade = new Date(colaborador.validade);
                    return validade >= hoje;
                }
                
                if (filterEPI === 'nao') {
                    return colaborador.epi === 'Não';
                }
                
                return true;
            });
            
            // Atualizar tabela
            const tbody = document.querySelector('#colaboradoresTable tbody');
            if (tbody) {
                tbody.innerHTML = colaboradoresFiltrados.map(colaborador => {
                    const hoje = new Date();
                    const validade = colaborador.validade ? new Date(colaborador.validade) : null;
                    let status = 'Sem EPI';
                    let badgeClass = 'warning';
                    
                    if (colaborador.epi === 'Sim' && validade) {
                        const diffTime = validade - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays < 0) {
                            status = 'Vencido';
                            badgeClass = 'danger';
                        } else if (diffDays < 30) {
                            status = 'Vence em breve';
                            badgeClass = 'warning';
                        } else {
                            status = 'Válido';
                            badgeClass = 'success';
                        }
                    } else if (colaborador.epi === 'Não') {
                        status = 'Sem EPI';
                        badgeClass = 'warning';
                    }
                    
                    return `
                        <tr>
                            <td>${colaborador.nome}</td>
                            <td>${colaborador.cpf}</td>
                            <td>${colaborador.cargo}</td>
                            <td>${colaborador.empresa}</td>
                            <td>${colaborador.epi}</td>
                            <td>${colaborador.validade || '-'}</td>
                            <td><span class="badge badge-${badgeClass}">${status}</span></td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-secondary btn-sm" onclick="openModal('colaborador', ${colaborador.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="confirmarExclusao('colaborador', ${colaborador.id}, '${colaborador.nome}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                if (colaboradoresFiltrados.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 30px;">
                                Nenhum colaborador encontrado com os filtros aplicados.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function filtrarEPIs() {
            const filterStatus = document.getElementById('filterStatusEPI').value;
            const filterTipo = document.getElementById('filterTipoEPI').value;
            const empresaData = getCurrentEmpresaData();
            
            if (!empresaData) return;
            
            const hoje = new Date();
            let episFiltrados = empresaData.epis.filter(epi => {
                // Filtro por tipo
                if (filterTipo && epi.tipo !== filterTipo) return false;
                
                // Filtro por status
                if (!filterStatus) return true;
                
                if (filterStatus === 'vencido') {
                    if (!epi.validade) return false;
                    const validade = new Date(epi.validade);
                    return validade < hoje;
                }
                
                return epi.status === filterStatus;
            });
            
            // Atualizar tabela
            const tbody = document.querySelector('#episTable tbody');
            if (tbody) {
                tbody.innerHTML = episFiltrados.map(epi => {
                    const hoje = new Date();
                    const validade = epi.validade ? new Date(epi.validade) : null;
                    let diasParaVencer = null;
                    let statusClass = '';
                    
                    if (validade) {
                        const diffTime = validade - hoje;
                        diasParaVencer = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diasParaVencer < 0) {
                            statusClass = 'danger';
                        } else if (diasParaVencer < 30) {
                            statusClass = 'warning';
                        } else {
                            statusClass = 'success';
                        }
                    }
                    
                    return `
                        <tr>
                            <td>${epi.tipo}</td>
                            <td>${epi.marca}</td>
                            <td>${epi.lote}</td>
                            <td>${epi.quantidade || 0}</td>
                            <td>${epi.validade || '-'}</td>
                            <td><span class="badge badge-${statusClass}">${epi.status}</span></td>
                            <td>
                                ${diasParaVencer !== null ? `
                                    <span class="${diasParaVencer < 0 ? 'text-danger' : diasParaVencer < 30 ? 'text-warning' : 'text-success'}">
                                        ${diasParaVencer < 0 ? 'Vencido' : `${diasParaVencer} dias`}
                                    </span>
                                ` : '-'}
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-secondary btn-sm" onclick="openModal('epi', ${epi.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="inspecionarEPI(${epi.id})">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                if (episFiltrados.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 30px;">
                                Nenhum EPI encontrado com os filtros aplicados.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function registrarInspecao() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const epiId = parseInt(document.getElementById('epiSelect').value);
            const data = document.getElementById('dataInspecao').value;
            const condicao = document.getElementById('condicaoEPI').value;
            const observacoes = document.getElementById('observacoes').value;
            const inspetor = document.getElementById('inspetor').value;
            
            if (!epiId || !data || !condicao) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            const epi = empresaData.epis.find(e => e.id === epiId);
            if (!epi) {
                showMessage('error', 'EPI não encontrado!');
                return;
            }
            
            const inspecao = {
                id: generateId(),
                epiId,
                epiNome: `${epi.tipo} - ${epi.marca}`,
                data,
                condicao,
                observacoes,
                inspetor,
                empresaId: currentEmpresaId
            };
            
            // Atualizar status do EPI
            epi.status = condicao === 'Aprovado' ? 'Disponível' : 'Manutenção';
            
            if (!empresaData.inspecoes) {
                empresaData.inspecoes = [];
            }
            
            empresaData.inspecoes.push(inspecao);
            saveToLocalStorage();
            
            showMessage('success', 'Inspeção registrada com sucesso!');
            
            // Limpar formulário
            document.getElementById('epiSelect').value = '';
            document.getElementById('dataInspecao').value = new Date().toISOString().split('T')[0];
            document.getElementById('condicaoEPI').value = 'Aprovado';
            document.getElementById('observacoes').value = '';
            
            // Atualizar tabela
            loadPage('inspecao-epi');
        }

        function visualizarInspecao(id) {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const inspecao = empresaData.inspecoes.find(i => i.id === id);
            if (!inspecao) return;
            
            openModal('visualizar-inspecao', id);
        }

        function inspecionarEPI(id) {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const epi = empresaData.epis.find(e => e.id === id);
            if (epi) {
                document.getElementById('epiSelect').value = id;
                openModal('epi', id);
            }
        }

        function inspecionarExtintor(id) {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const extintor = empresaData.extintores.find(e => e.id === id);
            if (extintor) {
                openModal('extintor', id);
            }
        }

        // Funções de Exportação - Excel
        function exportarClientesExcel() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Relatório de Clientes', '', '', '', '', ''],
                ['Empresa:', sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || '', '', '', '', ''],
                ['Data:', new Date().toLocaleDateString('pt-BR'), '', '', '', ''],
                [],
                ['Nome', 'CNPJ', 'Responsável', 'Telefone', 'E-mail', 'Data Cadastro']
            ];
            
            empresaData.clientes.forEach(cliente => {
                wsData.push([
                    cliente.nome,
                    cliente.cnpj,
                    cliente.responsavel,
                    cliente.telefone,
                    cliente.email || '',
                    cliente.dataCadastro || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 30}, // Nome
                {wch: 20}, // CNPJ
                {wch: 25}, // Responsável
                {wch: 15}, // Telefone
                {wch: 30}, // E-mail
                {wch: 12}  // Data Cadastro
            ];
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
            XLSX.writeFile(wb, `Clientes_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportarColaboradoresExcel() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Relatório de Colaboradores', '', '', '', '', '', '', ''],
                ['Empresa:', sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || '', '', '', '', '', '', ''],
                ['Data:', new Date().toLocaleDateString('pt-BR'), '', '', '', '', '', ''],
                [],
                ['Nome', 'CPF', 'Cargo', 'Empresa', 'EPI', 'Validade EPI', 'Data Admissão', 'Status']
            ];
            
            const hoje = new Date();
            empresaData.colaboradores.forEach(colaborador => {
                let status = 'Sem EPI';
                if (colaborador.epi === 'Sim' && colaborador.validade) {
                    const validade = new Date(colaborador.validade);
                    const diffTime = validade - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        status = 'Vencido';
                    } else if (diffDays < 30) {
                        status = 'Vence em breve';
                    } else {
                        status = 'Válido';
                    }
                }
                
                wsData.push([
                    colaborador.nome,
                    colaborador.cpf,
                    colaborador.cargo,
                    colaborador.empresa,
                    colaborador.epi,
                    colaborador.validade || '',
                    colaborador.dataAdmissao || '',
                    status
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 25}, // Nome
                {wch: 15}, // CPF
                {wch: 20}, // Cargo
                {wch: 20}, // Empresa
                {wch: 10}, // EPI
                {wch: 12}, // Validade
                {wch: 12}, // Data Admissão
                {wch: 15}  // Status
            ];
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Colaboradores');
            XLSX.writeFile(wb, `Colaboradores_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportarEPIsExcel() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Relatório de EPIs', '', '', '', '', '', '', ''],
                ['Empresa:', sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || '', '', '', '', '', '', ''],
                ['Data:', new Date().toLocaleDateString('pt-BR'), '', '', '', '', '', ''],
                [],
                ['Tipo', 'Marca', 'Lote', 'Quantidade', 'Validade', 'Status', 'Dias para Vencer', 'Situação']
            ];
            
            const hoje = new Date();
            empresaData.epis.forEach(epi => {
                let diasParaVencer = '';
                let situacao = '';
                
                if (epi.validade) {
                    const validade = new Date(epi.validade);
                    const diffTime = validade - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    diasParaVencer = diffDays.toString();
                    
                    if (diffDays < 0) {
                        situacao = 'Vencido';
                    } else if (diffDays < 30) {
                        situacao = 'Vence em breve';
                    } else {
                        situacao = 'OK';
                    }
                }
                
                wsData.push([
                    epi.tipo,
                    epi.marca,
                    epi.lote,
                    epi.quantidade || 0,
                    epi.validade || '',
                    epi.status,
                    diasParaVencer,
                    situacao
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 20}, // Tipo
                {wch: 15}, // Marca
                {wch: 12}, // Lote
                {wch: 10}, // Quantidade
                {wch: 12}, // Validade
                {wch: 12}, // Status
                {wch: 15}, // Dias para Vencer
                {wch: 12}  // Situação
            ];
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, 'EPIs');
            XLSX.writeFile(wb, `EPIs_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportarInspecoesExcel() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Relatório de Inspeções', '', '', '', '', ''],
                ['Empresa:', sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || '', '', '', '', ''],
                ['Data:', new Date().toLocaleDateString('pt-BR'), '', '', '', ''],
                [],
                ['EPI', 'Data Inspeção', 'Condição', 'Inspetor', 'Observações', 'Dias desde Inspeção']
            ];
            
            const hoje = new Date();
            if (empresaData.inspecoes) {
                empresaData.inspecoes.forEach(inspecao => {
                    const dataInspecao = new Date(inspecao.data);
                    const diffTime = hoje - dataInspecao;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    wsData.push([
                        inspecao.epiNome,
                        inspecao.data,
                        inspecao.condicao,
                        inspecao.inspetor,
                        inspecao.observacoes || '',
                        diffDays.toString()
                    ]);
                });
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 30}, // EPI
                {wch: 12}, // Data
                {wch: 15}, // Condição
                {wch: 20}, // Inspetor
                {wch: 40}, // Observações
                {wch: 15}  // Dias
            ];
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Inspeções');
            XLSX.writeFile(wb, `Inspeções_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportarFornecedoresExcel() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Relatório de Fornecedores', '', '', '', '', ''],
                ['Empresa:', sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || '', '', '', '', ''],
                ['Data:', new Date().toLocaleDateString('pt-BR'), '', '', '', ''],
                [],
                ['Nome', 'Tipo', 'Contato', 'Telefone', 'E-mail']
            ];
            
            empresaData.fornecedores.forEach(fornecedor => {
                wsData.push([
                    fornecedor.nome,
                    fornecedor.tipo,
                    fornecedor.contato,
                    fornecedor.telefone,
                    fornecedor.email || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 30}, // Nome
                {wch: 15}, // Tipo
                {wch: 20}, // Contato
                {wch: 15}, // Telefone
                {wch: 25}  // E-mail
            ];
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Fornecedores');
            XLSX.writeFile(wb, `Fornecedores_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportarExtintoresExcel() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Relatório de Extintores', '', '', '', '', '', ''],
                ['Empresa:', sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || '', '', '', '', '', ''],
                ['Data:', new Date().toLocaleDateString('pt-BR'), '', '', '', '', ''],
                [],
                ['Tipo', 'Capacidade', 'Localização', 'Validade', 'Próxima Inspeção', 'Status', 'Situação']
            ];
            
            const hoje = new Date();
            empresaData.extintores.forEach(extintor => {
                let situacao = '';
                if (extintor.validade) {
                    const validade = new Date(extintor.validade);
                    const diffTime = validade - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        situacao = 'Vencido';
                    } else if (diffDays < 30) {
                        situacao = 'Vence em breve';
                    } else {
                        situacao = 'OK';
                    }
                }
                
                wsData.push([
                    extintor.tipo,
                    extintor.capacidade,
                    extintor.localizacao,
                    extintor.validade,
                    extintor.proximaInspecao || '',
                    extintor.status,
                    situacao
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Ajustar largura das colunas
            const wscols = [
                {wch: 15}, // Tipo
                {wch: 12}, // Capacidade
                {wch: 25}, // Localização
                {wch: 12}, // Validade
                {wch: 12}, // Próxima Inspeção
                {wch: 12}, // Status
                {wch: 12}  // Situação
            ];
            ws['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(wb, ws, 'Extintores');
            XLSX.writeFile(wb, `Extintores_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Funções de Exportação - PDF
        function exportarClientesPDF() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.text('Relatório de Clientes', 20, 20);
            doc.setFontSize(10);
            doc.text(`Empresa: ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || ''}`, 20, 30);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
            
            // Dados da tabela
            const headers = [['Nome', 'CNPJ', 'Responsável', 'Telefone', 'E-mail', 'Data Cadastro']];
            const data = empresaData.clientes.map(cliente => [
                cliente.nome,
                cliente.cnpj,
                cliente.responsavel,
                cliente.telefone,
                cliente.email || '-',
                cliente.dataCadastro || '-'
            ]);
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 40,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [52, 152, 219] }
            });
            
            // Salvar PDF
            doc.save(`Clientes_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarColaboradoresPDF() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.text('Relatório de Colaboradores', 20, 20);
            doc.setFontSize(10);
            doc.text(`Empresa: ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || ''}`, 20, 30);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
            
            // Dados da tabela
            const headers = [['Nome', 'CPF', 'Cargo', 'Empresa', 'EPI', 'Validade', 'Status']];
            const hoje = new Date();
            const data = empresaData.colaboradores.map(colaborador => {
                let status = 'Sem EPI';
                if (colaborador.epi === 'Sim' && colaborador.validade) {
                    const validade = new Date(colaborador.validade);
                    const diffTime = validade - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        status = 'Vencido';
                    } else if (diffDays < 30) {
                        status = 'Vence em breve';
                    } else {
                        status = 'Válido';
                    }
                }
                
                return [
                    colaborador.nome,
                    colaborador.cpf,
                    colaborador.cargo,
                    colaborador.empresa,
                    colaborador.epi,
                    colaborador.validade || '-',
                    status
                ];
            });
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 40,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [46, 204, 113] }
            });
            
            // Salvar PDF
            doc.save(`Colaboradores_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarEPIsPDF() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.text('Relatório de EPIs', 20, 20);
            doc.setFontSize(10);
            doc.text(`Empresa: ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || ''}`, 20, 30);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
            
            // Dados da tabela
            const headers = [['Tipo', 'Marca', 'Lote', 'Quantidade', 'Validade', 'Status', 'Situação']];
            const hoje = new Date();
            const data = empresaData.epis.map(epi => {
                let situacao = '';
                if (epi.validade) {
                    const validade = new Date(epi.validade);
                    const diffTime = validade - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        situacao = 'Vencido';
                    } else if (diffDays < 30) {
                        situacao = 'Vence em breve';
                    } else {
                        situacao = 'OK';
                    }
                }
                
                return [
                    epi.tipo,
                    epi.marca,
                    epi.lote,
                    epi.quantidade || 0,
                    epi.validade || '-',
                    epi.status,
                    situacao
                ];
            });
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 40,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [231, 76, 60] }
            });
            
            // Salvar PDF
            doc.save(`EPIs_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarInspecoesPDF() {
            const empresaData = getCurrentEmpresaData();
            if (!empresaData) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(16);
            doc.text('Relatório de Inspeções', 20, 20);
            doc.setFontSize(10);
            doc.text(`Empresa: ${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || ''}`, 20, 30);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
            
            // Dados da tabela
            const headers = [['EPI', 'Data', 'Condição', 'Inspetor', 'Observações']];
            const data = empresaData.inspecoes ? empresaData.inspecoes.map(inspecao => [
                inspecao.epiNome,
                inspecao.data,
                inspecao.condicao,
                inspecao.inspetor,
                inspecao.observacoes || '-'
            ]) : [];
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 40,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [243, 156, 18] }
            });
            
            // Salvar PDF
            doc.save(`Inspeções_${sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa'}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Funções de Relatórios
        function gerarRelatorioCompletoExcel() {
            const wb = XLSX.utils.book_new();
            const empresaData = getCurrentEmpresaData();
            const empresaNome = sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa';
            
            // Clientes
            if (empresaData.clientes.length > 0) {
                const wsClientes = XLSX.utils.aoa_to_sheet([
                    ['Clientes'],
                    [],
                    ['Nome', 'CNPJ', 'Responsável', 'Telefone', 'E-mail', 'Data Cadastro']
                ].concat(empresaData.clientes.map(c => [c.nome, c.cnpj, c.responsavel, c.telefone, c.email || '', c.dataCadastro || ''])));
                XLSX.utils.book_append_sheet(wb, wsClientes, 'Clientes');
            }
            
            // Colaboradores
            if (empresaData.colaboradores.length > 0) {
                const wsColabs = XLSX.utils.aoa_to_sheet([
                    ['Colaboradores'],
                    [],
                    ['Nome', 'CPF', 'Cargo', 'Empresa', 'EPI', 'Validade EPI', 'Data Admissão']
                ].concat(empresaData.colaboradores.map(c => [c.nome, c.cpf, c.cargo, c.empresa, c.epi, c.validade || '', c.dataAdmissao || ''])));
                XLSX.utils.book_append_sheet(wb, wsColabs, 'Colaboradores');
            }
            
            // EPIs
            if (empresaData.epis.length > 0) {
                const wsEPIs = XLSX.utils.aoa_to_sheet([
                    ['EPIs'],
                    [],
                    ['Tipo', 'Marca', 'Lote', 'Quantidade', 'Validade', 'Status']
                ].concat(empresaData.epis.map(e => [e.tipo, e.marca, e.lote, e.quantidade || 0, e.validade || '', e.status])));
                XLSX.utils.book_append_sheet(wb, wsEPIs, 'EPIs');
            }
            
            // Inspeções
            if (empresaData.inspecoes && empresaData.inspecoes.length > 0) {
                const wsInspecoes = XLSX.utils.aoa_to_sheet([
                    ['Inspeções'],
                    [],
                    ['EPI', 'Data', 'Condição', 'Inspetor', 'Observações']
                ].concat(empresaData.inspecoes.map(i => [i.epiNome, i.data, i.condicao, i.inspetor, i.observacoes || ''])));
                XLSX.utils.book_append_sheet(wb, wsInspecoes, 'Inspeções');
            }
            
            // Fornecedores
            if (empresaData.fornecedores.length > 0) {
                const wsFornecedores = XLSX.utils.aoa_to_sheet([
                    ['Fornecedores'],
                    [],
                    ['Nome', 'Tipo', 'Contato', 'Telefone', 'E-mail']
                ].concat(empresaData.fornecedores.map(f => [f.nome, f.tipo, f.contato, f.telefone, f.email || ''])));
                XLSX.utils.book_append_sheet(wb, wsFornecedores, 'Fornecedores');
            }
            
            // Extintores
            if (empresaData.extintores.length > 0) {
                const wsExtintores = XLSX.utils.aoa_to_sheet([
                    ['Extintores'],
                    [],
                    ['Tipo', 'Capacidade', 'Localização', 'Validade', 'Próxima Inspeção', 'Status']
                ].concat(empresaData.extintores.map(e => [e.tipo, e.capacidade, e.localizacao, e.validade, e.proximaInspecao || '', e.status])));
                XLSX.utils.book_append_sheet(wb, wsExtintores, 'Extintores');
            }
            
            // Resumo
            const wsResumo = XLSX.utils.aoa_to_sheet([
                ['Resumo da Empresa'],
                [],
                ['Item', 'Quantidade'],
                ['Clientes', empresaData.clientes.length],
                ['Colaboradores', empresaData.colaboradores.length],
                ['EPIs', empresaData.epis.length],
                ['Inspeções', empresaData.inspecoes ? empresaData.inspecoes.length : 0],
                ['Fornecedores', empresaData.fornecedores.length],
                ['Extintores', empresaData.extintores.length],
                [],
                ['Relatório gerado em:', new Date().toLocaleString('pt-BR')]
            ]);
            XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');
            
            XLSX.writeFile(wb, `Relatorio_Completo_${empresaNome}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function gerarRelatorioCompletoPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const empresaData = getCurrentEmpresaData();
            const empresaNome = sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa';
            
            let yPos = 20;
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.text('Relatório Completo', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.text(`Empresa: ${empresaNome}`, 20, yPos);
            yPos += 7;
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, yPos);
            yPos += 15;
            
            // Resumo
            doc.setFontSize(14);
            doc.text('Resumo da Empresa', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.text(`• Clientes: ${empresaData.clientes.length}`, 20, yPos);
            yPos += 7;
            doc.text(`• Colaboradores: ${empresaData.colaboradores.length}`, 20, yPos);
            yPos += 7;
            doc.text(`• EPIs: ${empresaData.epis.length}`, 20, yPos);
            yPos += 7;
            doc.text(`• Inspeções: ${empresaData.inspecoes ? empresaData.inspecoes.length : 0}`, 20, yPos);
            yPos += 7;
            doc.text(`• Fornecedores: ${empresaData.fornecedores.length}`, 20, yPos);
            yPos += 7;
            doc.text(`• Extintores: ${empresaData.extintores.length}`, 20, yPos);
            yPos += 15;
            
            // Alertas
            const hoje = new Date();
            const colaboradoresVencidos = empresaData.colaboradores.filter(c => {
                if (c.epi !== 'Sim' || !c.validade) return false;
                const validade = new Date(c.validade);
                return validade < hoje;
            }).length;
            
            const episVencidos = empresaData.epis.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                return validade < hoje;
            }).length;
            
            if (colaboradoresVencidos > 0 || episVencidos > 0) {
                doc.setFontSize(12);
                doc.setTextColor(231, 76, 60); // Vermelho
                doc.text('Alertas de Vencimento:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                if (colaboradoresVencidos > 0) {
                    doc.text(`• ${colaboradoresVencidos} colaborador(es) com EPI vencido`, 20, yPos);
                    yPos += 7;
                }
                if (episVencidos > 0) {
                    doc.text(`• ${episVencidos} EPI(s) vencido(s)`, 20, yPos);
                    yPos += 7;
                }
                doc.setTextColor(0, 0, 0); // Voltar ao preto
                yPos += 10;
            }
            
            // Estatísticas
            doc.setFontSize(12);
            doc.text('Estatísticas:', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            const episDisponiveis = empresaData.epis.filter(e => e.status === 'Disponível').length;
            const porcentagemDisponivel = empresaData.epis.length > 0 ? 
                Math.round((episDisponiveis / empresaData.epis.length) * 100) : 0;
            
            doc.text(`• EPIs disponíveis: ${episDisponiveis} (${porcentagemDisponivel}%)`, 20, yPos);
            yPos += 7;
            
            if (empresaData.inspecoes && empresaData.inspecoes.length > 0) {
                const inspecoesAprovadas = empresaData.inspecoes.filter(i => i.condicao === 'Aprovado').length;
                const porcentagemAprovada = Math.round((inspecoesAprovadas / empresaData.inspecoes.length) * 100);
                doc.text(`• Inspeções aprovadas: ${inspecoesAprovadas} (${porcentagemAprovada}%)`, 20, yPos);
                yPos += 7;
            }
            
            // Recomendações
            yPos += 10;
            doc.setFontSize(12);
            doc.text('Recomendações:', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            if (colaboradoresVencidos > 0) {
                doc.text(`• Renovar EPIs de ${colaboradoresVencidos} colaborador(es)`, 20, yPos);
                yPos += 7;
            }
            if (episVencidos > 0) {
                doc.text(`• Substituir ${episVencidos} EPI(s) vencido(s)`, 20, yPos);
                yPos += 7;
            }
            if (empresaData.inspecoes && empresaData.inspecoes.length === 0) {
                doc.text('• Realizar inspeções periódicas nos EPIs', 20, yPos);
                yPos += 7;
            }
            
            // Rodapé
            doc.setFontSize(8);
            doc.text(`Relatório gerado automaticamente pelo SAS Sistema - Página 1/1`, 20, 280);
            
            doc.save(`Relatorio_Completo_${empresaNome}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function gerarRelatorioInspecoes() {
            exportarInspecoesExcel();
        }

        function gerarRelatorioVencimentos() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const empresaData = getCurrentEmpresaData();
            const empresaNome = sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa';
            const hoje = new Date();
            
            let yPos = 20;
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.text('Relatório de Vencimentos', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.text(`Empresa: ${empresaNome}`, 20, yPos);
            yPos += 7;
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, yPos);
            yPos += 15;
            
            // Colaboradores com EPI vencido
            const colaboradoresVencidos = empresaData.colaboradores.filter(c => {
                if (c.epi !== 'Sim' || !c.validade) return false;
                const validade = new Date(c.validade);
                return validade < hoje;
            });
            
            if (colaboradoresVencidos.length > 0) {
                doc.setFontSize(14);
                doc.text('Colaboradores com EPI Vencido:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                colaboradoresVencidos.forEach((colab, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`${index + 1}. ${colab.nome} - CPF: ${colab.cpf}`, 20, yPos);
                    yPos += 7;
                    doc.text(`   Cargo: ${colab.cargo} | Validade: ${colab.validade}`, 20, yPos);
                    yPos += 7;
                });
                yPos += 10;
            }
            
            // EPIs vencidos
            const episVencidos = empresaData.epis.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                return validade < hoje;
            });
            
            if (episVencidos.length > 0) {
                doc.setFontSize(14);
                doc.text('EPIs Vencidos:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                episVencidos.forEach((epi, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`${index + 1}. ${epi.tipo} - ${epi.marca}`, 20, yPos);
                    yPos += 7;
                    doc.text(`   Lote: ${epi.lote} | Validade: ${epi.validade}`, 20, yPos);
                    yPos += 7;
                });
                yPos += 10;
            }
            
            // EPIs próximos do vencimento (30 dias)
            const episProximos = empresaData.epis.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                const diffTime = validade - hoje;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 30;
            });
            
            if (episProximos.length > 0) {
                doc.setFontSize(14);
                doc.text('EPIs Próximos do Vencimento (≤ 30 dias):', 20, yPos);
                yPos += 10;
                
                const headers = [['Tipo', 'Marca', 'Lote', 'Validade', 'Dias Restantes']];
                const data = episProximos.map(epi => {
                    const validade = new Date(epi.validade);
                    const diffTime = validade - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return [epi.tipo, epi.marca, epi.lote, epi.validade, diffDays.toString()];
                });
                
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: yPos,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [243, 156, 18] }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
            }
            
            // Extintores vencidos
            const extintoresVencidos = empresaData.extintores.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                return validade < hoje;
            });
            
            if (extintoresVencidos.length > 0) {
                doc.setFontSize(14);
                doc.text('Extintores Vencidos:', 20, yPos);
                yPos += 10;
                
                const headers = [['Tipo', 'Capacidade', 'Localização', 'Validade']];
                const data = extintoresVencidos.map(ext => [
                    ext.tipo, 
                    ext.capacidade, 
                    ext.localizacao, 
                    ext.validade
                ]);
                
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: yPos,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [231, 76, 60] }
                });
            }
            
            // Rodapé
            doc.setFontSize(8);
            doc.text(`Relatório de vencimentos - SAS Sistema - Página 1/1`, 20, 280);
            
            doc.save(`Relatorio_Vencimentos_${empresaNome}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function gerarRelatorioEstatisticas() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const empresaData = getCurrentEmpresaData();
            const empresaNome = sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa';
            const hoje = new Date();
            
            let yPos = 20;
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.text('Relatório Estatístico', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.text(`Empresa: ${empresaNome}`, 20, yPos);
            yPos += 7;
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, yPos);
            yPos += 15;
            
            // Estatísticas gerais
            doc.setFontSize(14);
            doc.text('Estatísticas Gerais', 20, yPos);
            yPos += 10;
            
            const stats = [
                ['Clientes cadastrados', empresaData.clientes.length],
                ['Colaboradores ativos', empresaData.colaboradores.length],
                ['EPIs em estoque', empresaData.epis.length],
                ['Fornecedores', empresaData.fornecedores.length],
                ['Extintores', empresaData.extintores.length],
                ['Inspeções realizadas', empresaData.inspecoes ? empresaData.inspecoes.length : 0]
            ];
            
            doc.setFontSize(10);
            stats.forEach(([label, value]) => {
                doc.text(`• ${label}: ${value}`, 20, yPos);
                yPos += 7;
            });
            yPos += 10;
            
            // Status dos EPIs
            if (empresaData.epis.length > 0) {
                const statusCounts = {};
                empresaData.epis.forEach(epi => {
                    statusCounts[epi.status] = (statusCounts[epi.status] || 0) + 1;
                });
                
                doc.setFontSize(14);
                doc.text('Distribuição de EPIs por Status', 20, yPos);
                yPos += 10;
                
                Object.entries(statusCounts).forEach(([status, count]) => {
                    const percentage = Math.round((count / empresaData.epis.length) * 100);
                    doc.setFontSize(10);
                    doc.text(`• ${status}: ${count} (${percentage}%)`, 20, yPos);
                    yPos += 7;
                });
                yPos += 10;
            }
            
            // Inspeções por mês (últimos 6 meses)
            if (empresaData.inspecoes && empresaData.inspecoes.length > 0) {
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                
                const inspecoesRecentes = empresaData.inspecoes.filter(i => {
                    const dataInspecao = new Date(i.data);
                    return dataInspecao >= sixMonthsAgo;
                });
                
                if (inspecoesRecentes.length > 0) {
                    doc.setFontSize(14);
                    doc.text('Inspeções nos Últimos 6 Meses', 20, yPos);
                    yPos += 10;
                    
                    const monthlyCounts = {};
                    inspecoesRecentes.forEach(inspecao => {
                        const date = new Date(inspecao.data);
                        const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                        monthlyCounts[monthYear] = (monthlyCounts[monthYear] || 0) + 1;
                    });
                    
                    doc.setFontSize(10);
                    Object.entries(monthlyCounts).forEach(([month, count]) => {
                        doc.text(`• ${month}: ${count} inspeções`, 20, yPos);
                        yPos += 7;
                    });
                    yPos += 10;
                }
            }
            
            // Vencimentos próximos
            const colaboradoresComVencimentoProximo = empresaData.colaboradores.filter(c => {
                if (c.epi !== 'Sim' || !c.validade) return false;
                const validade = new Date(c.validade);
                const diffTime = validade - hoje;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 30;
            }).length;
            
            const episComVencimentoProximo = empresaData.epis.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                const diffTime = validade - hoje;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 30;
            }).length;
            
            if (colaboradoresComVencimentoProximo > 0 || episComVencimentoProximo > 0) {
                doc.setFontSize(14);
                doc.text('Alertas Próximos (≤ 30 dias)', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                if (colaboradoresComVencimentoProximo > 0) {
                    doc.text(`• ${colaboradoresComVencimentoProximo} colaborador(es) com EPI próximo do vencimento`, 20, yPos);
                    yPos += 7;
                }
                if (episComVencimentoProximo > 0) {
                    doc.text(`• ${episComVencimentoProximo} EPI(s) próximo(s) do vencimento`, 20, yPos);
                    yPos += 7;
                }
            }
            
            // Rodapé
            doc.setFontSize(8);
            doc.text(`Relatório estatístico - SAS Sistema - Página 1/1`, 20, 280);
            
            doc.save(`Relatorio_Estatistico_${empresaNome}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function gerarRelatorioCompliance() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const empresaData = getCurrentEmpresaData();
            const empresaNome = sistemaData.empresas.find(e => e.id === currentEmpresaId)?.nome || 'Empresa';
            const hoje = new Date();
            
            let yPos = 20;
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.text('Relatório de Compliance', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.text(`Empresa: ${empresaNome}`, 20, yPos);
            yPos += 7;
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, yPos);
            yPos += 15;
            
            // NRs relevantes
            doc.setFontSize(14);
            doc.text('Normas Regulamentadoras Aplicáveis', 20, yPos);
            yPos += 10;
            
            const nrsRelevantes = [
                { nr: 'NR 6', titulo: 'EPI', descricao: 'Equipamentos de Proteção Individual', status: 'Em conformidade' },
                { nr: 'NR 7', titulo: 'PCMSO', descricao: 'Programa de Controle Médico', status: 'A avaliar' },
                { nr: 'NR 9', titulo: 'PPRA', descricao: 'Programa de Prevenção de Riscos', status: 'A avaliar' },
                { nr: 'NR 10', titulo: 'Eletricidade', descricao: 'Segurança em eletricidade', status: 'Em conformidade' },
                { nr: 'NR 23', titulo: 'Proteção Contra Incêndios', descricao: 'Extintores e prevenção', status: 'Em conformidade' },
                { nr: 'NR 35', titulo: 'Trabalho em Altura', descricao: 'Segurança em altura', status: 'A avaliar' }
            ];
            
            doc.setFontSize(10);
            nrsRelevantes.forEach((item, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                let color;
                switch(item.status) {
                    case 'Em conformidade': color = [46, 204, 113]; break; // Verde
                    case 'A avaliar': color = [243, 156, 18]; break; // Amarelo
                    case 'Não conforme': color = [231, 76, 60]; break; // Vermelho
                    default: color = [0, 0, 0];
                }
                
                doc.setTextColor(color[0], color[1], color[2]);
                doc.text(`${item.nr} - ${item.titulo}: ${item.status}`, 20, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 7;
                
                doc.setFontSize(8);
                doc.text(`   ${item.descricao}`, 20, yPos);
                yPos += 7;
                doc.setFontSize(10);
            });
            yPos += 10;
            
            // Conformidade de EPIs
            doc.setFontSize(14);
            doc.text('Conformidade de EPIs', 20, yPos);
            yPos += 10;
            
            const totalColaboradores = empresaData.colaboradores.length;
            const colaboradoresComEPI = empresaData.colaboradores.filter(c => c.epi === 'Sim').length;
            const porcentagemEPI = totalColaboradores > 0 ? 
                Math.round((colaboradoresComEPI / totalColaboradores) * 100) : 0;
            
            doc.setFontSize(10);
            doc.text(`• Colaboradores com EPI: ${colaboradoresComEPI}/${totalColaboradores} (${porcentagemEPI}%)`, 20, yPos);
            yPos += 7;
            
            const colaboradoresEPIValido = empresaData.colaboradores.filter(c => {
                if (c.epi !== 'Sim' || !c.validade) return false;
                const validade = new Date(c.validade);
                return validade >= hoje;
            }).length;
            const porcentagemValido = colaboradoresComEPI > 0 ? 
                Math.round((colaboradoresEPIValido / colaboradoresComEPI) * 100) : 0;
            
            doc.text(`• EPIs válidos: ${colaboradoresEPIValido}/${colaboradoresComEPI} (${porcentagemValido}%)`, 20, yPos);
            yPos += 10;
            
            // Conformidade de Extintores
            doc.setFontSize(14);
            doc.text('Conformidade de Extintores', 20, yPos);
            yPos += 10;
            
            const extintoresValidos = empresaData.extintores.filter(e => {
                if (!e.validade) return false;
                const validade = new Date(e.validade);
                return validade >= hoje;
            }).length;
            const porcentagemExtintoresValidos = empresaData.extintores.length > 0 ? 
                Math.round((extintoresValidos / empresaData.extintores.length) * 100) : 0;
            
            doc.setFontSize(10);
            doc.text(`• Extintores válidos: ${extintoresValidos}/${empresaData.extintores.length} (${porcentagemExtintoresValidos}%)`, 20, yPos);
            yPos += 10;
            
            // Recomendações
            doc.setFontSize(14);
            doc.text('Recomendações para Melhoria', 20, yPos);
            yPos += 10;
            
            const recomendacoes = [];
            
            if (porcentagemEPI < 100) {
                recomendacoes.push(`• Implementar programa de fornecimento de EPIs para 100% dos colaboradores`);
            }
            
            if (porcentagemValido < 100) {
                recomendacoes.push(`• Renovar EPIs vencidos imediatamente`);
            }
            
            if (empresaData.inspecoes && empresaData.inspecoes.length === 0) {
                recomendacoes.push(`• Implementar programa de inspeções periódicas de EPIs`);
            }
            
            if (empresaData.extintores.length === 0) {
                recomendacoes.push(`• Instalar extintores de incêndio conforme NR 23`);
            }
            
            if (recomendacoes.length > 0) {
                doc.setFontSize(10);
                recomendacoes.forEach(rec => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(rec, 20, yPos);
                    yPos += 7;
                });
            } else {
                doc.setFontSize(10);
                doc.text('• Todas as conformidades estão em dia. Parabéns!', 20, yPos);
                yPos += 7;
            }
            
            // Rodapé
            doc.setFontSize(8);
            doc.text(`Relatório de compliance - SAS Sistema - Página 1/1`, 20, 280);
            
            doc.save(`Relatorio_Compliance_${empresaNome}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function gerarRelatorioPersonalizado(formato) {
            const tipo = document.getElementById('tipoRelatorio').value;
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            if (!tipo) {
                showMessage('error', 'Selecione o tipo de relatório!');
                return;
            }
            
            switch(tipo) {
                case 'clientes':
                    formato === 'excel' ? exportarClientesExcel() : exportarClientesPDF();
                    break;
                case 'colaboradores':
                    formato === 'excel' ? exportarColaboradoresExcel() : exportarColaboradoresPDF();
                    break;
                case 'epis':
                    formato === 'excel' ? exportarEPIsExcel() : exportarEPIsPDF();
                    break;
                case 'inspecoes':
                    formato === 'excel' ? exportarInspecoesExcel() : exportarInspecoesPDF();
                    break;
                case 'extintores':
                    formato === 'excel' ? exportarExtintoresExcel() : null; // Não tem PDF ainda
                    break;
            }
        }

        // Funções de Edição (mantidas para compatibilidade)
        function editarCliente(id) {
            openModal('cliente', id);
        }

        function editarColaborador(id) {
            openModal('colaborador', id);
        }

        function editarFornecedor(id) {
            openModal('fornecedor', id);
        }

        function editarEPI(id) {
            openModal('epi', id);
        }

        function editarExtintor(id) {
            openModal('extintor', id);
        }

        function editarUsuario(id) {
            openModal('usuario', id);
        }

        function editarEmpresa(id) {
            openModal('empresa', id);
        }

        // Adicionar Font Awesome
        const fa = document.createElement('link');
        fa.rel = 'stylesheet';
        fa.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(fa);
    </script>
</body>
</html>